# 极速分镜 - 阿里云服务器部署指南

本文档介绍如何在阿里云服务器上部署极速分镜的云端协作服务。

## 目录

1. [服务器要求](#服务器要求)
2. [环境准备](#环境准备)
3. [MongoDB 安装与配置](#mongodb-安装与配置)
4. [后端服务部署](#后端服务部署)
5. [前端部署](#前端部署)
6. [Nginx 配置](#nginx-配置)
7. [SSL 证书配置](#ssl-证书配置)
8. [系统服务配置](#系统服务配置)
9. [防火墙配置](#防火墙配置)
10. [常见问题](#常见问题)

---

## 服务器要求

### 最低配置
- CPU: 2核
- 内存: 4GB
- 硬盘: 40GB SSD
- 带宽: 5Mbps

### 推荐配置
- CPU: 4核
- 内存: 8GB
- 硬盘: 100GB SSD
- 带宽: 10Mbps+

### 操作系统
- Ubuntu 20.04/22.04 LTS（推荐）
- CentOS 7/8
- Alibaba Cloud Linux

---

## 环境准备

### 1. 连接服务器

```bash
ssh root@your-server-ip
```

### 2. 更新系统

**Ubuntu/Debian:**
```bash
apt update && apt upgrade -y
```

**CentOS/Alibaba Cloud Linux:**
```bash
yum update -y
```

### 3. 安装 Node.js (v18+)

```bash
# 使用 nvm 安装（推荐）
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
source ~/.bashrc
nvm install 18
nvm use 18
nvm alias default 18

# 验证安装
node -v
npm -v
```

### 4. 安装 Git

```bash
# Ubuntu
apt install git -y

# CentOS
yum install git -y
```

### 5. 安装 PM2（进程管理器）

```bash
npm install -g pm2
```

---

## MongoDB 安装与配置

### 1. 安装 MongoDB

**Ubuntu 22.04:**
```bash
# 导入公钥
curl -fsSL https://pgp.mongodb.com/server-7.0.asc | \
   sudo gpg -o /usr/share/keyrings/mongodb-server-7.0.gpg \
   --dearmor

# 添加源
echo "deb [ arch=amd64,arm64 signed-by=/usr/share/keyrings/mongodb-server-7.0.gpg ] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/7.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-7.0.list

# 安装
apt update
apt install -y mongodb-org

# 启动服务
systemctl start mongod
systemctl enable mongod
```

**CentOS/Alibaba Cloud Linux:**
```bash
# 创建 repo 文件
cat > /etc/yum.repos.d/mongodb-org-7.0.repo << EOF
[mongodb-org-7.0]
name=MongoDB Repository
baseurl=https://repo.mongodb.org/yum/redhat/\$releasever/mongodb-org/7.0/x86_64/
gpgcheck=1
enabled=1
gpgkey=https://pgp.mongodb.com/server-7.0.asc
EOF

# 安装
yum install -y mongodb-org

# 启动服务
systemctl start mongod
systemctl enable mongod
```

### 2. 配置 MongoDB 认证（生产环境必须）

```bash
# 连接 MongoDB
mongosh

# 创建管理员用户
use admin
db.createUser({
  user: "admin",
  pwd: "your-strong-admin-password",
  roles: [ { role: "root", db: "admin" } ]
})

# 创建应用数据库用户
use mediastory
db.createUser({
  user: "mediastory",
  pwd: "your-strong-app-password",
  roles: [ { role: "readWrite", db: "mediastory" } ]
})

exit
```

### 3. 启用认证

编辑 MongoDB 配置文件：

```bash
vim /etc/mongod.conf
```

添加/修改以下内容：

```yaml
security:
  authorization: enabled

net:
  port: 27017
  bindIp: 127.0.0.1  # 仅本地访问，更安全
```

重启 MongoDB：

```bash
systemctl restart mongod
```

---

## 后端服务部署

### 1. 克隆项目

```bash
cd /var/www
git clone https://github.com/your-repo/mediastory.git
cd mediastory
```

### 2. 配置后端环境变量

```bash
cd server
cp .env.example .env
vim .env
```

编辑 `.env` 文件：

```env
# 服务器端口
PORT=3001

# MongoDB 连接字符串（带认证）
MONGODB_URI=mongodb://mediastory:your-strong-app-password@127.0.0.1:27017/mediastory

# JWT 密钥（使用强随机字符串）
# 生成方法: openssl rand -base64 32
JWT_SECRET=your-generated-jwt-secret-key

# 前端 URL
FRONTEND_URL=https://your-domain.com
```

### 3. 安装依赖并构建

```bash
npm install
npm run build
```

### 4. 使用 PM2 启动服务

```bash
pm2 start dist/index.js --name mediastory-server
pm2 save
pm2 startup  # 设置开机自启
```

### 5. 查看服务状态

```bash
pm2 status
pm2 logs mediastory-server
```

---

## 前端部署

### 1. 配置前端环境变量

```bash
cd /var/www/mediastory
cp .env.example .env
vim .env
```

编辑 `.env` 文件：

```env
# 后端 API 地址
VITE_API_URL=https://your-domain.com/api

# WebSocket 服务地址
VITE_WS_URL=https://your-domain.com
```

### 2. 构建前端

```bash
npm install
npm run build
```

构建产物在 `dist` 目录中。

---

## Nginx 配置

### 1. 安装 Nginx

```bash
# Ubuntu
apt install nginx -y

# CentOS
yum install nginx -y
```

### 2. 创建配置文件

```bash
vim /etc/nginx/sites-available/mediastory
```

添加以下配置：

```nginx
# HTTP 重定向到 HTTPS
server {
    listen 80;
    server_name your-domain.com;
    return 301 https://$server_name$request_uri;
}

# HTTPS 配置
server {
    listen 443 ssl http2;
    server_name your-domain.com;

    # SSL 证书配置
    ssl_certificate /etc/nginx/ssl/your-domain.com.pem;
    ssl_certificate_key /etc/nginx/ssl/your-domain.com.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256;
    ssl_prefer_server_ciphers on;

    # 前端静态文件
    root /var/www/mediastory/dist;
    index index.html;

    # 前端路由
    location / {
        try_files $uri $uri/ /index.html;
    }

    # API 代理
    location /api {
        proxy_pass http://127.0.0.1:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;

        # 大文件上传支持
        client_max_body_size 100M;
    }

    # WebSocket 代理
    location /socket.io {
        proxy_pass http://127.0.0.1:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # 静态资源缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2)$ {
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
}
```

### 3. 启用配置

```bash
# Ubuntu
ln -s /etc/nginx/sites-available/mediastory /etc/nginx/sites-enabled/

# 测试配置
nginx -t

# 重启 Nginx
systemctl restart nginx
systemctl enable nginx
```

---

## SSL 证书配置

### 方法一：使用阿里云免费证书

1. 登录阿里云控制台
2. 进入 SSL 证书服务
3. 申请免费 DV 证书
4. 下载 Nginx 格式证书
5. 上传到服务器 `/etc/nginx/ssl/` 目录

### 方法二：使用 Let's Encrypt

```bash
# 安装 Certbot
apt install certbot python3-certbot-nginx -y

# 获取证书
certbot --nginx -d your-domain.com

# 自动续期
certbot renew --dry-run
```

---

## 系统服务配置

### PM2 开机自启

```bash
pm2 startup systemd
pm2 save
```

### 查看服务状态

```bash
# PM2 状态
pm2 status

# Nginx 状态
systemctl status nginx

# MongoDB 状态
systemctl status mongod
```

---

## 防火墙配置

### 阿里云安全组配置

在阿里云控制台配置安全组规则：

| 端口 | 协议 | 说明 |
|------|------|------|
| 22   | TCP  | SSH  |
| 80   | TCP  | HTTP |
| 443  | TCP  | HTTPS |

**注意：** 不要开放 3001 端口（后端）和 27017 端口（MongoDB）到公网。

### 服务器防火墙（可选）

```bash
# Ubuntu (ufw)
ufw allow 22
ufw allow 80
ufw allow 443
ufw enable

# CentOS (firewalld)
firewall-cmd --permanent --add-service=ssh
firewall-cmd --permanent --add-service=http
firewall-cmd --permanent --add-service=https
firewall-cmd --reload
```

---

## 常见问题

### 1. WebSocket 连接失败

**检查项：**
- Nginx WebSocket 代理配置是否正确
- 阿里云安全组是否开放 443 端口
- 后端服务是否正常运行

**调试命令：**
```bash
# 查看后端日志
pm2 logs mediastory-server

# 查看 Nginx 日志
tail -f /var/log/nginx/error.log
```

### 2. MongoDB 连接失败

**检查项：**
- MongoDB 服务是否运行
- 连接字符串是否正确
- 用户名密码是否正确

**调试命令：**
```bash
# 检查 MongoDB 状态
systemctl status mongod

# 测试连接
mongosh "mongodb://mediastory:password@127.0.0.1:27017/mediastory"
```

### 3. 上传文件失败

**检查项：**
- Nginx `client_max_body_size` 设置
- 后端 JSON body 大小限制

**解决方案：**
在 Nginx 配置中增加：
```nginx
client_max_body_size 100M;
```

### 4. 服务自动重启

**使用 PM2 监控：**
```bash
# 设置内存限制自动重启
pm2 start dist/index.js --name mediastory-server --max-memory-restart 1G

# 设置文件变化自动重启（开发环境）
pm2 start dist/index.js --name mediastory-server --watch
```

---

## 环境变量说明

### 后端 (.env)

| 变量 | 说明 | 示例 |
|------|------|------|
| `PORT` | 服务端口 | `3001` |
| `MONGODB_URI` | MongoDB 连接字符串 | `mongodb://user:pass@host:27017/db` |
| `JWT_SECRET` | JWT 签名密钥 | 随机字符串，至少 32 位 |
| `FRONTEND_URL` | 前端地址 | `https://your-domain.com` |

### 前端 (.env)

| 变量 | 说明 | 示例 |
|------|------|------|
| `VITE_API_URL` | 后端 API 地址 | `https://your-domain.com/api` |
| `VITE_WS_URL` | WebSocket 地址 | `https://your-domain.com` |

---

## 维护命令

```bash
# 重启后端服务
pm2 restart mediastory-server

# 查看后端日志
pm2 logs mediastory-server --lines 100

# 重启 Nginx
systemctl restart nginx

# 重启 MongoDB
systemctl restart mongod

# 更新代码
cd /var/www/mediastory
git pull
npm install
npm run build
cd server
npm install
npm run build
pm2 restart mediastory-server
```

---

## 备份策略

### MongoDB 备份

```bash
# 创建备份脚本
cat > /root/backup-mongo.sh << 'EOF'
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR=/var/backups/mongodb
mkdir -p $BACKUP_DIR
mongodump --uri="mongodb://mediastory:password@127.0.0.1:27017/mediastory" --out=$BACKUP_DIR/$DATE
# 保留最近 7 天
find $BACKUP_DIR -type d -mtime +7 -exec rm -rf {} +
EOF

chmod +x /root/backup-mongo.sh

# 添加定时任务（每天凌晨 3 点）
crontab -e
# 添加: 0 3 * * * /root/backup-mongo.sh
```

---

如有问题，请查看日志文件或联系技术支持。
